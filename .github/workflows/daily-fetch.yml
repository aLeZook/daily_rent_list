name: Daily Rentcast Fetch

on:
  schedule:
    - cron: '0 9 * * *'  # Runs every day at 9:00 AM UTC
  workflow_dispatch:      # Allows manual trigger

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest

    steps:
      - name: Fetch Rentcast Data
        run: |
          curl --request GET \
               --url 'https://api.rentcast.io/v1/listings/rental/long-term?city=San%20Marcos&state=CA&zipCode=92069&status=Active&limit=500' \
               --header "X-Api-Key: ${{ secrets.RENTCAST_API_KEY }}" \
               --header "accept: application/json" \
               --output rentcast_output.json

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Split and Send to Discord (with Google Maps links)
        run: |
          jq empty rentcast_output.json || { echo "Invalid JSON file"; exit 1; }

          MAX=5
          COUNT=$(jq length rentcast_output.json)
          echo "Total listings: $COUNT"
          BATCHES=$(( (COUNT + MAX - 1) / MAX ))

          for ((i=0; i<BATCHES; i++)); do
            MSG=$(jq -r ".[$((i*MAX)):$(((i+1)*MAX))] | map(
              \"🏠 [\(.formattedAddress)](https://www.google.com/maps/search/?api=1&query=\(.formattedAddress | gsub(\" \"; \"+\"))) — \(.bedrooms)bd/\(.bathrooms)ba — \$\(.price)/mo — \(.propertyType)\"
            ) | join(\"\n\")" rentcast_output.json)

            # Ensure message is escaped properly for JSON
            PAYLOAD=$(jq -Rn --arg msg "**Listings Batch $((i+1))/$BATCHES**\n$MSG" '{content: $msg}')

            echo "Sending batch $((i+1)) of $BATCHES..."
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "$PAYLOAD" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}

            sleep 1
          done
