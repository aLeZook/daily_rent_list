name: Daily Rentcast Fetch

on:
  schedule:
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch Rentcast Data
        run: |
          curl --request GET \
               --url 'https://api.rentcast.io/v1/listings/rental/long-term?city=San%20Marcos&state=CA&zipCode=92069&status=Active&limit=500' \
               --header "X-Api-Key: ${{ secrets.RENTCAST_API_KEY }}" \
               --header "accept: application/json" \
               --output rentcast_output.json

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Split and Send to Discord
        run: |
          MAX=5
          COUNT=$(jq length rentcast_output.json)
          BATCHES=$(( (COUNT + MAX - 1) / MAX ))
          for ((i=0; i<BATCHES; i++)); do
            MSG=$(jq -r ".[$((i*MAX)):$(((i+1)*MAX))] | map(
              \"ðŸ  \(.formattedAddress) â€” \(.bedrooms)bd/\(.bathrooms)ba â€” \$\(.price)/mo â€” \(.propertyType)\"
            ) | join(\"\n\")" rentcast_output.json)
            
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{\"content\": \"**Listings Batch $((i+1))/$BATCHES**\n$MSG\"}" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}

            sleep 1
          done
